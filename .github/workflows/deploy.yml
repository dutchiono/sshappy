name: Deploy & Build APK

on:
  push:
    branches: [ main ]

permissions:
  contents: write
  issues: write

jobs:
  deploy-and-build:
    name: Deploy Site + Build APK on Server
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install sshpass
        run: sudo apt-get update && sudo apt-get install -y sshpass

      - name: Deploy site and build APK on server
        id: server-build
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          command_timeout: 30m
          script: |
            export HOME=/home/sshappy
            export ANDROID_HOME=/opt/android-sdk
            export JAVA_HOME=/usr/lib/jvm/java-21-openjdk-amd64
            export PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools:$ANDROID_HOME/build-tools/34.0.0:$JAVA_HOME/bin

            APP_DIR="/var/www/sshappy"
            REPO_URL="https://github.com/iono-such-things/sshappy.git"

            cd $APP_DIR

            # Update remote to org repo if needed
            CURRENT_REMOTE=$(git remote get-url origin 2>/dev/null || echo "")
            if [ "$CURRENT_REMOTE" != "$REPO_URL" ]; then
              git remote set-url origin $REPO_URL
            fi

            # Pull latest code
            git fetch origin main
            git reset --hard origin/main

            echo "=== Installing dependencies ==="
            npm install --legacy-peer-deps

            echo "=== Running expo prebuild ==="
            npx expo prebuild --platform android --no-install --clean

            echo "=== Building APK with Gradle ==="
            cd android
            chmod +x gradlew
            set +e
            ./gradlew assembleRelease 2>&1 | tee /tmp/sshappy-build.log
            BUILD_EXIT=${PIPESTATUS[0]}
            set -e

            if [ $BUILD_EXIT -eq 0 ]; then
              echo "BUILD_SUCCESS"
              mkdir -p $APP_DIR/builds
              cp app/build/outputs/apk/release/app-release.apk $APP_DIR/builds/sshappy-latest.apk
              echo "APK_READY"
            else
              echo "BUILD_FAILED"
              exit 1
            fi

      - name: Download APK from server
        if: success()
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_PASSWORD: ${{ secrets.SERVER_PASSWORD }}
        run: |
          sshpass -p "$SERVER_PASSWORD" scp -o StrictHostKeyChecking=no \
            "${SERVER_USER}@${SERVER_HOST}:/var/www/sshappy/builds/sshappy-latest.apk" \
            ./sshappy-latest.apk
          ls -la sshappy-latest.apk

      - name: Create GitHub Release
        if: success()
        uses: softprops/action-gh-release@v2
        with:
          tag_name: build-${{ github.run_number }}
          name: "SSHappy Build #${{ github.run_number }}"
          body: |
            Automated build from commit ${{ github.sha }}

            **Changes:** ${{ github.event.head_commit.message }}
          files: sshappy-latest.apk
          make_latest: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Download build log from server (on failure)
        if: failure()
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_PASSWORD: ${{ secrets.SERVER_PASSWORD }}
        run: |
          sshpass -p "$SERVER_PASSWORD" scp -o StrictHostKeyChecking=no \
            "${SERVER_USER}@${SERVER_HOST}:/tmp/sshappy-build.log" \
            ./sshappy-build.log 2>/dev/null || echo "No build log available" > ./sshappy-build.log

      - name: Create GitHub Issue on build failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let buildLog = 'No build log available';
            try {
              buildLog = fs.readFileSync('sshappy-build.log', 'utf8');
              if (buildLog.length > 60000) {
                buildLog = '...(truncated)...\n' + buildLog.slice(-60000);
              }
            } catch (e) {
              buildLog = 'Could not read build log: ' + e.message;
            }

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Build failed: #${context.runNumber} - ${new Date().toISOString().split('T')[0]}`,
              body: `## Build Failure Report\n\n**Commit:** ${context.sha}\n**Branch:** ${context.ref}\n**Workflow Run:** [#${context.runNumber}](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})\n\n### Build Log\n\n\`\`\`\n${buildLog}\n\`\`\``,
              labels: ['build-failure', 'automated']
            });
